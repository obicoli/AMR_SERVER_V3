import _extends from"@babel/runtime/helpers/extends";import BinDecider,{DEFAULT_THRESHOLD_PIXELS}from"@fusioncharts/utils/src/bin-decider";import{timeDay,timeHour,timeWeek,timeYear,timeMonth,timeMinute,timeSecond,timeMillisecond}from"@fusioncharts/utils/src/time-intervals";import{utcDay,utcHour,utcWeek,utcYear,utcMonth,utcMinute,utcSecond,utcMillisecond}from"@fusioncharts/utils/src/time-intervals/utc";import Log from"@fusioncharts/utils/src/scales/ft-log";import extent from"@fusioncharts/utils/src/array/extent";import Linear from"@fusioncharts/utils/src/scales/linear";import ScaleTime from"@fusioncharts/utils/src/scales/time";import ScaleUTCTime from"@fusioncharts/utils/src/scales/utc";import isObject from"@fusioncharts/utils/src/type/is-object";import ScaleTimeBin from"@fusioncharts/utils/src/scales/time-bin";import timeFormatter from"@fusioncharts/utils/src/time-converter";import ScaleUTCTimeBin from"@fusioncharts/utils/src/scales/utc-bin";import{getDefaultBins,getCustomBins}from"@fusioncharts/utils/src/bin-decider/standard-bins";import{getAtomicity,getFormatStore}from"../../_utils/atomicity";import{TIME_SPAN}from"@fusioncharts/utils/src/defaults/time";import{less}from"@fusioncharts/datatable/src/operators";var TYPES={time:ScaleTimeBin,utctime:ScaleUTCTimeBin,scaletime:ScaleTime,scaleutctime:ScaleUTCTime,numeric:Linear,log:Log},SHARE_RATIO=.8;export default function(chart){var config=chart.config,focusAxesX=config.focusAxesX,customBin=focusAxesX[0].binning,contextAxesX=config.contextAxesX||[],atomicity=[],table=config.dataTable,_table$getData=table.getData(),schema=_table$getData.schema,data=_table$getData.data,isUTC=chart.getFromEnv("UTC"),firstDate,timeIntervals=isUTC?{Day:utcDay,Hour:utcHour,Week:utcWeek,Year:utcYear,Month:utcMonth,Minute:utcMinute,Second:utcSecond,Millisecond:utcMillisecond}:{Day:timeDay,Hour:timeHour,Week:timeWeek,Year:timeYear,Month:timeMonth,Minute:timeMinute,Second:timeSecond,Millisecond:timeMillisecond},chartWidth=chart.getFromEnv("chartWidth"),range=[0,SHARE_RATIO*chartWidth/focusAxesX.length],makeScale=function makeScale(_ref){var _ref$type=_ref.type,type=_ref$type===void 0?"time":_ref$type;var Scale=(type==="time"&&isUTC?TYPES["utc"+type]:TYPES[type])||TYPES.time;return new Scale},makeBin=function makeBin(_ref2,index){var _ref2$type=_ref2.type,type=_ref2$type===void 0?"time":_ref2$type,plot=_ref2.plot;var defaultStandardBin,Scale=(type==="time"&&isUTC?TYPES["scaleutc"+type]:TYPES["scale"+type])||TYPES.time,scale=new Scale,bin;if(type==="time"&&isUTC){defaultStandardBin=getDefaultBins(utcYear,utcMonth,utcWeek,utcDay,utcHour,utcMinute,utcSecond,utcMillisecond)}else{defaultStandardBin=getDefaultBins(timeYear,timeMonth,timeWeek,timeDay,timeHour,timeMinute,timeSecond,timeMillisecond)}if(customBin){if(type==="time"&&isUTC){bin=new BinDecider(getCustomBins(utcYear,utcMonth,utcWeek,utcDay,utcHour,utcMinute,utcSecond,utcMillisecond,customBin))}else{bin=new BinDecider(getCustomBins(timeYear,timeMonth,timeWeek,timeDay,timeHour,timeMinute,timeSecond,timeMillisecond,customBin))}}else{bin=new BinDecider(defaultStandardBin)}bin.setScale(scale);if(!atomicity[index]){var info=atomicity[index]=_extends({},getFormatStore(schema[table.indexOf(plot[0].value)].format));info.minBin=getAtomicity(_extends({},info,{index:table.indexOf(plot[0].value),data:data,bins:bin.getStandardBins(),intervalIndexMap:bin.intervalIndexMap}))}bin.setBinMin(atomicity[index].minBin);bin.setBinRange(range);bin.setRangeThreshold(config.pixelMultiplier*DEFAULT_THRESHOLD_PIXELS);return bin},makeScalesBins=function makeScalesBins(axesX){var scales=[],bins=[],i,len=axesX.length;for(i=0;i<len;i++){scales[i]=makeScale(axesX[i]);bins[i]=makeBin(axesX[i],i);scales[i].setThresholdIntervals(bins[i].getStandardBins());scales[i].setBinMin(bins[i].getBinMin());scales[i].setRangeThreshold(bins[i].getRangeThreshold())}return{scales:scales,bins:bins}},contextInfo=makeScalesBins(contextAxesX),focusInfo=makeScalesBins(focusAxesX),minMaxFn=function minMaxFn(_ref3){var value=_ref3.value;return[table.min(value),table.max(value)]},calculateDomain=function calculateDomain(axis){var _ref4;var arr=axis.plot.map(minMaxFn),context=extent((_ref4=[]).concat.apply(_ref4,arr),Number),minBinDuration=contextInfo.bins[0].getBinMin()[2],value=axis.plot[0].value,format=axis.format||schema.find((function(_ref5){var name=_ref5.name;return name===value})).format,parser=timeFormatter.parser(format),initialInterval=isObject(axis.initialinterval)?axis.initialinterval:{},setMin=function setMin(userMin,dataMin){var min=parser.parse(userMin);if(min===null){return dataMin}return min<dataMin?+min:dataMin},setMax=function setMax(userMax,dataMax){var max=parser.parse(userMax);if(max===null){return dataMax}return max>dataMax?+max:dataMax},focus;config.rawDataXStart=context[0];if(!data.length&&(typeof context[0]==="undefined"||typeof context[1]==="undefined")){context[0]=+TIME_SPAN[0];context[1]=+TIME_SPAN[1]}if(config.timeSpread&&config.timeSpread.duration>=minBinDuration*3){context[0]=+timeIntervals[config.timeSpread.unit.name].offset(context[1],-config.timeSpread.multiplier)}else if(data.length<3){if(data.length===0){context[0]=+TIME_SPAN[0];context[1]=context[0]+minBinDuration*3}else{context[0]=context[1]-minBinDuration*2}}focus=context.slice();focus[0]=setMax(initialInterval.from,focus[0]);focus[1]=setMin(initialInterval.to,focus[1]);focus=extent(focus);return{focus:focus,context:context}},calculatedDomains;config.atomicity=atomicity;firstDate=data.length?data[data.length-1][config.dateColumnIndex]:+TIME_SPAN[0];if(config.timeSpread&&config.timeSpread.duration){table.getDataStore().deleteRows(less(chart.getFromEnv("dateColumn").name,Math.min(config.timeSpread.interval.offset(firstDate,-config.timeSpread.multiplier),contextInfo.bins[0].getRangeThreshold()[0].offset(firstDate,-2))),table.getID())}calculatedDomains=calculateDomain(contextAxesX[0]);chart.addToEnv("contextScalesX",contextInfo.scales);chart.addToEnv("focusScalesX",focusInfo.scales);chart.addToEnv("contextBins",contextInfo.bins);chart.addToEnv("focusBins",focusInfo.bins);chart.setContextLimit(calculatedDomains.context);chart.setFocusLimit(calculatedDomains.focus)}